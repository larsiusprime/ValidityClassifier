<details open id="status">
  <summary>Status</summary>
  <div>
    <small>User labels: valid=<b>{{ pos }}</b>, invalid=<b>{{ neg }}</b>>
      {% if can_predict %}<span class="badge">Ready to predict</span>{% else %}<span class="badge">{{ predict_title }}</span>{% endif %}
    </small>
  </div>
</details>
<form id="predict-form" hx-post="/predict" hx-target="#table" hx-swap="innerHTML" style="margin: 0.5rem 0 1rem 0;">
  <button type="submit" title="{{ predict_title }}" {% if not can_predict %}disabled{% endif %}>{{ predict_text }}</button>
  <div class="predict-meta" aria-live="polite">
    <div class="thinking">Thinking...</div>
    {% if last_predicted_at %}
      <div class="last-run">Last predicted at {{ last_predicted_at }}</div>
    {% endif %}
  </div>
</form>
<div class="table-wrap">
  <table role="grid">
    <thead>
    <tr>
      <th>Actions</th>
      <th>valid_sale</th>
      {% for col in df.columns %}
        {% if col != 'valid_sale' %}
          <th>{{ col }}</th>
        {% endif %}
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for _, row in df.iterrows() %}
      {% set key = (row['key_primary'] | string) %}
      {% set source = sources.get(key, 'unknown') %}
      <tr id="row-{{ key }}">
        <!-- Actions first -->
        <td class="actions">
          {% if source == 'user' and row['valid_sale'] in ['valid', 'invalid'] %}
            <form hx-post="/unset" hx-target="#row-{{ key }}" hx-swap="outerHTML" hx-select="tr" style="display:inline">
              <input type="hidden" name="key" value="{{ key }}">
              <button type="submit" class="secondary">Unset</button>
            </form>
          {% else %}
            <form hx-post="/label" hx-target="#row-{{ key }}" hx-swap="outerHTML" hx-select="tr" style="display:inline">
              <input type="hidden" name="key" value="{{ key }}">
              <input type="hidden" name="value" value="valid">
              <button type="submit">valid</button>
            </form>
            <form hx-post="/label" hx-target="#row-{{ key }}" hx-swap="outerHTML" hx-select="tr" style="display:inline">
              <input type="hidden" name="key" value="{{ key }}">
              <input type="hidden" name="value" value="invalid">
              <button type="submit" class="contrast">invalid</button>
            </form>
          {% endif %}
        </td>

        <!-- valid_sale second, with special styling/heat/badges preserved -->
        {% set val = row['valid_sale'] %}
        {% set p = None %}
        {% if source == 'machine' %}
          {% set p = probas.get(key) %}
        {% endif %}
        {% if source == 'machine' and p is not none %}
          {% set idx = (p * 20)|int %}
          <td class="heat-{{ idx }}">
        {% elif val == 'valid' %}
          <td class="bg-valid">
        {% elif val == 'invalid' %}
          <td class="bg-invalid">
        {% else %}
          <td>
        {% endif %}
          {{ row['valid_sale'] }}
          {% if source == 'user' %}
            <span class="badge badge-user">user</span>
          {% elif source == 'machine' %}
            <span class="badge badge-machine">machine</span>
            {% if p is not none %}
              <span class="proba">({{ '%.0f' % (p*100) }}%)</span>
            {% endif %}
          {% endif %}
        </td>

        <!-- Remaining data columns (skip valid_sale here) -->
        {% for col in df.columns %}
          {% if col != 'valid_sale' %}
            <td>{{ row[col] }}</td>
          {% endif %}
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>
</div>
